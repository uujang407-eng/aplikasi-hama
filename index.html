<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pencatatan Data Tangkapan Hama</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- EXIF.js for image metadata -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <!-- Library untuk Excel & CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Library untuk PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .required-label::after { content: ' *'; color: #ef4444; }
        .action-button { transition: all 0.2s ease-in-out; }
        .action-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .nav-button { transition: all 0.2s ease-in-out; }
        .nav-button.active { background-color: #4f46e5; color: white; }
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            width: 16px; height: 16px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chat-bubble-user { background-color: #e0e7ff; align-self: flex-end; }
        .chat-bubble-ai { background-color: #f3f4f6; align-self: flex-start; }
        .quick-button {
            background-color: #eef2ff; color: #4338ca;
            border: 1px solid #c7d2fe;
            transition: all 0.2s ease-in-out;
        }
        .quick-button:hover { background-color: #c7d2fe; }

        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-block { display: block !important; }
            .print-container { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            .print-shadow-none { box-shadow: none !important; }
            .print-table img { width: 80px !important; height: 80px !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 no-print">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">üìù Aplikasi Pencatatan Data Tangkapan Hama</h1>
            <p class="text-gray-500 mt-2">Dengan Dashboard, Identifikasi AI, dan Asisten Chat.</p>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-8 no-print">
            <div class="flex justify-center bg-white p-2 rounded-xl shadow-md max-w-2xl mx-auto text-sm sm:text-base">
                <button id="show-dashboard-btn" class="nav-button w-full text-center py-2 px-4 rounded-lg font-semibold">üìä Dashboard</button>
                <button id="show-pest-id-btn" class="nav-button w-full text-center py-2 px-4 rounded-lg font-semibold">üî¨ Pest Identification AI</button>
                <button id="show-ai-assistant-btn" class="nav-button w-full text-center py-2 px-4 rounded-lg font-semibold">ü§ñ AI Assistant</button>
                <button id="show-data-btn" class="nav-button w-full text-center py-2 px-4 rounded-lg font-semibold active">üìù Input Data</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div id="main-content">
            <!-- Dashboard View -->
            <div id="dashboard-view" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-gray-500 text-sm font-medium">TOTAL TANGKAPAN</h3><p id="total-captures" class="text-4xl font-bold text-indigo-600 mt-2">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-gray-500 text-sm font-medium">HAMA TERBANYAK</h3><p id="top-pest" class="text-3xl font-bold text-indigo-600 mt-2">-</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center"><h3 class="text-gray-500 text-sm font-medium">LOKASI PALING RAWAN</h3><p id="top-location" class="text-3xl font-bold text-indigo-600 mt-2">-</p></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-semibold mb-4 text-gray-700">Tangkapan per Jenis Hama</h3><canvas id="pest-chart"></canvas></div>
            </div>

            <!-- Pest Identification AI View -->
            <div id="pest-identification-view" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 no-print">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-4 text-gray-700">üî¨ Pest Identification AI</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                        <div>
                            <label for="ai-vision-input" class="block text-sm font-medium text-gray-600 mb-2">1. Unggah Gambar untuk Analisis</label>
                            <input type="file" id="ai-vision-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <div id="ai-vision-preview" class="mt-4 bg-gray-100 rounded-lg p-2 h-64 flex items-center justify-center"><p class="text-gray-500 text-sm">Preview gambar akan muncul di sini</p></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">2. Mulai Analisis</label>
                            <button type="button" id="ai-vision-btn" class="action-button w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 mb-4" disabled>Analisis Gambar</button>
                            <label class="block text-sm font-medium text-gray-600 mb-2">3. Hasil Analisis</label>
                            <div id="ai-vision-result" class="text-sm text-gray-700 bg-gray-50 p-4 rounded-lg min-h-[150px] space-y-2"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg no-print">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-4 text-gray-700">Riwayat Analisis</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="history-search-pest" placeholder="Cari jenis hama..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <input type="text" id="history-search-location" placeholder="Cari lokasi..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <input type="date" id="history-search-date" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3">Tanggal</th><th class="px-4 py-3">Lokasi</th><th class="px-4 py-3">Hasil AI</th><th class="px-4 py-3">Confidence</th><th class="px-4 py-3">Gambar</th><th class="px-4 py-3">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="analysis-history-body"></tbody>
                        </table>
                        <p id="no-history-message" class="text-center text-gray-500 py-8">Belum ada riwayat analisis.</p>
                    </div>
                </div>
            </div>
            
            <!-- AI Assistant View -->
            <div id="ai-assistant-view" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg no-print">
                    <div class="flex justify-between items-center border-b pb-4 mb-4">
                         <h2 class="text-2xl font-semibold text-gray-700">ü§ñ AI Assistant untuk Teknisi</h2>
                         <button id="clear-chat-btn" class="text-xs text-gray-500 hover:text-red-600">Hapus Riwayat</button>
                    </div>
                    <div id="chat-window" class="h-96 overflow-y-auto p-4 bg-gray-100 rounded-lg mb-4 flex flex-col space-y-4">
                        <!-- Initial AI message is now dynamic -->
                    </div>
                    <div class="mb-4">
                        <div id="quick-questions-container" class="flex flex-wrap gap-2">
                           <!-- Quick question buttons will be inserted here -->
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <input type="text" id="chat-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Ketik pertanyaan Anda di sini...">
                        <button id="chat-send-btn" class="action-button px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Kirim</button>
                    </div>
                </div>
            </div>


            <!-- Data Input and Table View -->
            <div id="data-view">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 no-print">
                    <h2 id="form-title" class="text-2xl font-semibold mb-6 border-b pb-4 text-gray-700">Tambah Data Manual</h2>
                    <form id="pest-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="data-id">
                        <div>
                            <div class="mb-4"><label for="tanggal" class="required-label block text-sm font-medium text-gray-600 mb-2">Tanggal</label><input type="date" id="tanggal" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div class="mb-4"><label for="lokasi" class="required-label block text-sm font-medium text-gray-600 mb-2">Lokasi</label><input type="text" id="lokasi" placeholder="Contoh: Blok A" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div class="mb-4"><label for="jenis-hama" class="required-label block text-sm font-medium text-gray-600 mb-2">Jenis Hama</label><input type="text" id="jenis-hama" placeholder="Gunakan Analisis AI atau isi manual" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                            <div class="mb-4"><label for="jumlah" class="required-label block text-sm font-medium text-gray-600 mb-2">Jumlah</label><input type="number" id="jumlah" min="0" placeholder="Gunakan Analisis AI atau isi manual" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required></div>
                        </div>
                        <div>
                            <div class="mb-4"><label for="status" class="required-label block text-sm font-medium text-gray-600 mb-2">Status</label><select id="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" required><option value="">Pilih Status</option><option value="Pending">Pending</option><option value="Done">Done</option><option value="Observasi">Observasi</option></select></div>
                            <div class="mb-4"><label for="keterangan" class="block text-sm font-medium text-gray-600 mb-2">Keterangan</label><textarea id="keterangan" rows="3" placeholder="Informasi tambahan..." class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea></div>
                            <div class="mb-4"><label for="foto" class="block text-sm font-medium text-gray-600 mb-2">Lampirkan Foto (Maks. 3)</label><input type="file" id="foto" accept="image/*" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"><div id="image-preview" class="mt-4 flex flex-wrap gap-4"></div></div>
                        </div>
                        <div class="md:col-span-2 flex items-center justify-end gap-4"><button type="button" id="cancel-edit-btn" class="hidden px-6 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100">Batal</button><button type="submit" id="submit-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 shadow-md">Simpan Data</button></div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8 no-print">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                        <div>
                            <h2 class="text-xl font-semibold mb-3 text-gray-700">Impor Laporan</h2>
                            <p class="text-sm text-gray-500 mb-4">Unggah dari file .xlsx atau .csv.</p>
                            <input type="file" id="file-input" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <div id="import-status" class="mt-3 text-sm"></div>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold mb-3 text-gray-700">Aksi Laporan</h2>
                            <p class="text-sm text-gray-500 mb-4">Cetak, unduh, atau hapus semua data.</p>
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                <button id="print-btn" class="action-button w-full px-4 py-3 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700">Cetak</button>
                                <button id="excel-btn" class="action-button w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Excel</button>
                                <button id="pdf-btn" class="action-button w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">PDF</button>
                                <button id="delete-all-btn" class="action-button w-full px-4 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Hapus</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="report-section" class="bg-white p-6 rounded-xl shadow-lg print-shadow-none">
                    <div class="hidden print-block text-center mb-6"><h1 class="text-2xl font-bold text-gray-800">Laporan Data Hama</h1><p class="text-sm text-gray-500">Dicetak pada: <span id="print-date"></span></p></div>
                    <h2 class="text-2xl font-semibold mb-6 border-b pb-4 text-gray-700 no-print">Laporan Data</h2>
                    <div class="overflow-x-auto">
                        <table id="report-table" class="w-full text-sm text-left text-gray-600 print-table">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3">No</th><th class="px-4 py-3">Tanggal</th><th class="px-4 py-3">Lokasi</th>
                                    <th class="px-4 py-3">Jenis Hama</th><th class="px-4 py-3">Jumlah</th><th class="px-4 py-3">Keterangan</th>
                                    <th class="px-4 py-3">Status</th><th class="px-4 py-3" style="min-width: 200px;">Foto</th><th class="px-4 py-3 text-center no-print">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                        <p id="no-data-message" class="text-center text-gray-500 py-8">Belum ada data yang diinput.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- All JS code is here, including the fixes and restored content ---
            // --- DOM Elements ---
            const form = document.getElementById('pest-form');
            const dataIdInput = document.getElementById('data-id');
            const tanggalInput = document.getElementById('tanggal');
            const lokasiInput = document.getElementById('lokasi');
            const jenisHamaInput = document.getElementById('jenis-hama');
            const jumlahInput = document.getElementById('jumlah');
            const statusInput = document.getElementById('status');
            const keteranganInput = document.getElementById('keterangan');
            const fotoInput = document.getElementById('foto');
            const imagePreviewContainer = document.getElementById('image-preview');
            const tableBody = document.getElementById('data-table-body');
            const noDataMessage = document.getElementById('no-data-message');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const fileInput = document.getElementById('file-input');
            const importStatus = document.getElementById('import-status');
            const printBtn = document.getElementById('print-btn');
            const excelBtn = document.getElementById('excel-btn');
            const pdfBtn = document.getElementById('pdf-btn');
            const deleteAllBtn = document.getElementById('delete-all-btn');
            const showDashboardBtn = document.getElementById('show-dashboard-btn');
            const showDataBtn = document.getElementById('show-data-btn');
            const showAiBtn = document.getElementById('show-pest-id-btn');
            const showAiAssistantBtn = document.getElementById('show-ai-assistant-btn');
            const dashboardView = document.getElementById('dashboard-view');
            const dataView = document.getElementById('data-view');
            const aiView = document.getElementById('pest-identification-view');
            const aiAssistantView = document.getElementById('ai-assistant-view');
            const aiVisionInput = document.getElementById('ai-vision-input');
            const aiVisionPreview = document.getElementById('ai-vision-preview');
            const aiVisionBtn = document.getElementById('ai-vision-btn');
            const aiVisionResult = document.getElementById('ai-vision-result');
            const chatWindow = document.getElementById('chat-window');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const analysisHistoryBody = document.getElementById('analysis-history-body');
            const noHistoryMessage = document.getElementById('no-history-message');
            const historySearchPest = document.getElementById('history-search-pest');
            const historySearchLocation = document.getElementById('history-search-location');
            const historySearchDate = document.getElementById('history-search-date');
            const quickQuestionsContainer = document.getElementById('quick-questions-container');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            const totalCapturesEl = document.getElementById('total-captures');
            const topPestEl = document.getElementById('top-pest');
            const topLocationEl = document.getElementById('top-location');
            const pestChartCanvas = document.getElementById('pest-chart');

            // --- State Management ---
            let pestData = JSON.parse(localStorage.getItem('pestData')) || [];
            let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory')) || [];
            let currentPhotos = [];
            let aiVisionPhoto = null;
            let pestChart = null;
            let aiResultCache = [];
            const commonPests = ["Tikus Atap", "Tikus Got", "Lalat Buah", "Lalat Rumah", "Kecoa Jerman", "Kecoa Amerika", "Nyamuk Aedes Aegypti", "Semut Hitam", "Rayap Tanah", "Kotoran Tikus", "Jejak Lalat"];
            let lastAnalysisResultForAssistant = null;

            // --- Gemini API Functions ---
            const callGeminiAPI = async (prompt) => {
                const apiKey = "AIzaSyBKLT8DWnOrMOVvQfcfvLrK9ZeVFtp7TuU";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { "contents": [{ "parts": [{ "text": prompt }] }] };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("API call failed:", error);
                    return "Maaf, terjadi kesalahan saat menghubungi AI.";
                }
            };

            const callGeminiVision = async (prompt, base64ImageData) => {
                const apiKey = "AIzaSyBKLT8DWnOrMOVvQfcfvLrK9ZeVFtp7TuU";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const pureBase64 = base64ImageData.split(',')[1];
                const payload = {
                    "contents": [{ "parts": [{ "text": prompt }, { "inline_data": { "mime_type": "image/jpeg", "data": pureBase64 } }] }],
                    "generationConfig": { "responseMimeType": "application/json" }
                };
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("API call failed:", error);
                    return JSON.stringify([{ namaHama: "Gagal", jumlahHama: 0, confidence: 0, isTrace: false }]);
                }
            };
            
            // --- Core Functions ---
            const saveData = () => {
                localStorage.setItem('pestData', JSON.stringify(pestData));
                localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
            };
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}-${month}-${year}`;
            };

            const renderTable = () => {
                tableBody.innerHTML = '';
                const sortedData = pestData.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
                noDataMessage.classList.toggle('hidden', sortedData.length > 0);
                tableBody.parentElement.classList.toggle('hidden', sortedData.length === 0);
                sortedData.forEach((data, index) => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b hover:bg-gray-50';
                    let photosHTML = (data.foto && data.foto.length > 0) ? data.foto.map(src => `<img src="${src}" class="w-24 h-24 object-cover rounded-md inline-block mr-2 mb-2">`).join('') : '<span>-</span>';
                    tr.innerHTML = `
                        <td class="px-4 py-2 font-bold text-gray-700">${index + 1}</td>
                        <td class="px-4 py-2">${formatDate(data.tanggal)}</td>
                        <td class="px-4 py-2 font-medium text-gray-900">${data.lokasi}</td>
                        <td class="px-4 py-2">${data.jenisHama}</td>
                        <td class="px-4 py-2">${data.jumlah}</td>
                        <td class="px-4 py-2 text-xs">${data.keterangan || '-'}</td>
                        <td class="px-4 py-2"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">${data.status}</span></td>
                        <td class="px-4 py-2">${photosHTML}</td>
                        <td class="px-4 py-2 text-center no-print">
                            <button class="edit-btn font-medium text-blue-600 hover:underline mr-3" data-id="${data.id}">Edit</button>
                            <button class="delete-btn font-medium text-red-600 hover:underline" data-id="${data.id}">Hapus</button>
                        </td>`;
                    tableBody.appendChild(tr);
                });
            };

            const renderDashboard = () => {
                const totalCaptures = pestData.reduce((sum, item) => sum + parseInt(item.jumlah || 0, 10), 0);
                totalCapturesEl.textContent = totalCaptures;
                const pestCounts = pestData.reduce((acc, item) => { if(item.jenisHama) acc[item.jenisHama] = (acc[item.jenisHama] || 0) + parseInt(item.jumlah || 0, 10); return acc; }, {});
                const topPest = Object.keys(pestCounts).reduce((a, b) => pestCounts[a] > pestCounts[b] ? a : b, '-');
                topPestEl.textContent = topPest;
                const locationCounts = pestData.reduce((acc, item) => { if(item.lokasi) acc[item.lokasi] = (acc[item.lokasi] || 0) + parseInt(item.jumlah || 0, 10); return acc; }, {});
                const topLocation = Object.keys(locationCounts).reduce((a, b) => locationCounts[a] > locationCounts[b] ? a : b, '-');
                topLocationEl.textContent = topLocation;
                const chartLabels = Object.keys(pestCounts);
                const chartData = Object.values(pestCounts);
                if (pestChart) pestChart.destroy();
                const ctx = pestChartCanvas.getContext('2d');
                pestChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: chartLabels, datasets: [{ label: 'Jumlah Tangkapan', data: chartData, backgroundColor: 'rgba(79, 70, 229, 0.8)' }] },
                    options: { scales: { y: { beginAtZero: true } }, responsive: true }
                });
            };

            const fileToBase64 = (file) => new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
            });

            const renderImagePreview = () => {
                imagePreviewContainer.innerHTML = '';
                currentPhotos.forEach((src, index) => {
                    const previewWrapper = document.createElement('div');
                    previewWrapper.className = 'relative w-24 h-24';
                    previewWrapper.innerHTML = `<img src="${src}" class="w-full h-full object-cover rounded-lg shadow-md"><button type="button" data-index="${index}" class="remove-img-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold hover:bg-red-600">&times;</button>`;
                    imagePreviewContainer.appendChild(previewWrapper);
                });
            };

            const resetForm = () => {
                form.reset(); dataIdInput.value = ''; currentPhotos = [];
                renderImagePreview(); formTitle.textContent = 'Tambah Data Manual';
                submitBtn.textContent = 'Simpan Data'; cancelEditBtn.classList.add('hidden');
            };

            const startEdit = (id) => {
                const dataToEdit = pestData.find(data => data.id == id);
                if (dataToEdit) {
                    dataIdInput.value = dataToEdit.id; tanggalInput.value = dataToEdit.tanggal;
                    lokasiInput.value = dataToEdit.lokasi; jenisHamaInput.value = dataToEdit.jenisHama;
                    jumlahInput.value = dataToEdit.jumlah; statusInput.value = dataToEdit.status;
                    keteranganInput.value = dataToEdit.keterangan; currentPhotos = dataToEdit.foto || [];
                    renderImagePreview(); 
                    formTitle.textContent = `Edit Data`;
                    submitBtn.textContent = 'Update Data'; cancelEditBtn.classList.remove('hidden');
                    switchView('data');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const deleteData = (id) => {
                if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                    pestData = pestData.filter(data => data.id != id);
                    saveData(); renderTable(); renderDashboard();
                }
            };

            const switchView = (view) => {
                dashboardView.classList.add('hidden');
                dataView.classList.add('hidden');
                aiView.classList.add('hidden');
                aiAssistantView.classList.add('hidden');
                [showDashboardBtn, showDataBtn, showAiBtn, showAiAssistantBtn].forEach(btn => btn.classList.remove('active'));

                if (view === 'dashboard') {
                    dashboardView.classList.remove('hidden');
                    showDashboardBtn.classList.add('active');
                    renderDashboard();
                } else if (view === 'ai') {
                    aiView.classList.remove('hidden');
                    showAiBtn.classList.add('active');
                    renderAnalysisHistory();
                } else if (view === 'ai-assistant') {
                    aiAssistantView.classList.remove('hidden');
                    showAiAssistantBtn.classList.add('active');
                    initializeChat();
                }
                else {
                    dataView.classList.remove('hidden');
                    showDataBtn.classList.add('active');
                }
            };

            // --- Event Listeners ---
            showDashboardBtn.addEventListener('click', () => switchView('dashboard'));
            showDataBtn.addEventListener('click', () => switchView('data'));
            showAiBtn.addEventListener('click', () => switchView('ai'));
            showAiAssistantBtn.addEventListener('click', () => switchView('ai-assistant'));

            aiVisionInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                aiVisionPhoto = await fileToBase64(file);
                aiVisionPreview.innerHTML = `<img src="${aiVisionPhoto}" class="w-full h-full object-contain rounded-lg">`;
                aiVisionBtn.disabled = false;
                aiVisionResult.innerHTML = '';
            });

            const performAnalysis = async (photo, id = null) => {
                if (!photo) return;
                
                if(!id) {
                    aiVisionResult.innerHTML = '<div class="flex items-center gap-2"><div class="spinner"></div><span>Menganalisis...</span></div>';
                    aiVisionBtn.disabled = true;
                }

                const prompt = `Analisis gambar ini. Identifikasi SEMUA jenis hama spesifik (contoh: Tikus Atap, bukan hanya Tikus) DAN kotoran/jejak hama (contoh: Kotoran Tikus). Untuk setiap item, hitung jumlahnya dan berikan confidence score (0-100). Jawab HANYA dalam format array JSON. Setiap objek harus punya kunci "namaHama", "jumlahHama", "confidence", dan "isTrace" (boolean). Contoh: [{"namaHama": "Tikus Atap", "jumlahHama": 1, "confidence": 92, "isTrace": false}, {"namaHama": "Kotoran Tikus", "jumlahHama": 15, "confidence": 95, "isTrace": true}]`;
                const resultText = await callGeminiVision(prompt, photo);
                
                try {
                    aiResultCache = JSON.parse(resultText);
                    lastAnalysisResultForAssistant = aiResultCache; // Save for assistant
                    
                    let resultHTML = aiResultCache.map(item => {
                        const { namaHama, jumlahHama, confidence } = item;
                        const confidenceColor = confidence < 70 ? 'text-red-600' : 'text-green-600';
                        const confidenceWarning = confidence < 70 ? `<span class="text-xs ${confidenceColor}"> (verifikasi manual)</span>` : '';
                        return `<div class="p-2 border-b">
                                    <p><strong>${namaHama}</strong> - Jumlah: ${jumlahHama}</p>
                                    <p class="text-xs">Confidence: <span class="font-bold ${confidenceColor}">${confidence}%</span>${confidenceWarning}</p>
                                </div>`;
                    }).join('');
                    
                    resultHTML += `<div class="mt-2">
                                    <label class="text-xs font-medium">Ubah Manual:</label>
                                    <select id="manual-override-select" class="w-full text-xs p-1 border rounded">${commonPests.map(p => `<option value="${p}">${p}</option>`).join('')}</select>
                                 </div>
                                 <div class="flex gap-2 mt-2">
                                    <button id="use-ai-result-btn" class="w-full action-button px-4 py-2 text-xs bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">Gunakan Hasil untuk Input</button>
                                 </div>`;

                    if(id) {
                        const historyItem = analysisHistory.find(item => item.id === id);
                        if(historyItem) { historyItem.result = aiResultCache; saveData(); renderAnalysisHistory(); }
                    } else {
                        aiVisionResult.innerHTML = resultHTML;
                        const newHistoryItem = { id: Date.now(), date: new Date().toISOString(), location: 'Belum ditentukan', image: photo, result: aiResultCache };
                        analysisHistory.unshift(newHistoryItem);
                        saveData();
                        renderAnalysisHistory();
                    }

                } catch (e) {
                    if(!id) aiVisionResult.innerHTML = `<p>Gagal memproses hasil AI. Coba lagi.</p>`;
                    console.error("Error parsing AI result:", e);
                } finally {
                    if(!id) aiVisionBtn.disabled = false;
                }
            };

            aiVisionBtn.addEventListener('click', () => performAnalysis(aiVisionPhoto));
            
            aiVisionResult.addEventListener('click', (e) => {
                if (e.target.id === 'use-ai-result-btn' && aiResultCache.length > 0) {
                    const selectedPest = document.getElementById('manual-override-select').value;
                    const primaryPest = aiResultCache.find(p => p.namaHama === selectedPest) || aiResultCache.find(p => !p.isTrace) || aiResultCache[0];
                    jenisHamaInput.value = selectedPest;
                    jumlahInput.value = primaryPest.jumlahHama;
                    keteranganInput.value = aiResultCache.map(p => `${p.namaHama} (Jumlah: ${p.jumlahHama})`).join(', ');
                    switchView('data');
                }
            });

            const initializeChat = () => {
                chatWindow.innerHTML = '';
                let greeting = "Halo! Saya asisten Rentokil. Mau tahu cara atasi hama, dosis chemical, atau teknik baiting? Klik pertanyaan di bawah atau ketik langsung.";
                if(lastAnalysisResultForAssistant && lastAnalysisResultForAssistant.length > 0){
                    const primaryPest = lastAnalysisResultForAssistant.find(p => !p.isTrace) || lastAnalysisResultForAssistant[0];
                    greeting += `<br><br>Saya melihat Anda baru saja mengidentifikasi **${primaryPest.namaHama}**. Apakah Anda butuh rekomendasi tindakan?`;
                }
                const aiBubble = document.createElement('div');
                aiBubble.className = 'chat-bubble-ai p-3 rounded-lg max-w-md';
                aiBubble.innerHTML = formatAIResponse(greeting);
                chatWindow.appendChild(aiBubble);
                
                const quickQuestions = ["Cara atasi tikus got", "Dosis spray residual", "SOP fogging manual", "Jenis umpan blok", "Tips pasang perangkap lem", "Mode Pelatihan Teknisi Baru"];
                quickQuestionsContainer.innerHTML = quickQuestions.map(q => `<button class="quick-button text-xs font-semibold py-1 px-3 rounded-full">${q}</button>`).join('');
            };

            quickQuestionsContainer.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    chatInput.value = e.target.textContent;
                    handleChatSend();
                }
            });

            const formatAIResponse = (text) => {
                let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                if (html.includes('* ')) {
                    const items = html.split('\n').filter(line => line.trim().startsWith('* '));
                    const listItems = items.map(item => `<li>${item.trim().substring(2)}</li>`).join('');
                    html = html.replace(/(\* .+\n?)+/, `<ul>${listItems}</ul>`);
                }
                return html.replace(/\n/g, '<br>');
            };

            const handleChatSend = async () => {
                const userInput = chatInput.value.trim();
                if (userInput === '') return;
                const userBubble = document.createElement('div');
                userBubble.className = 'chat-bubble-user p-3 rounded-lg max-w-md';
                userBubble.textContent = userInput;
                chatWindow.appendChild(userBubble);
                chatInput.value = '';
                chatWindow.scrollTop = chatWindow.scrollHeight;
                const thinkingBubble = document.createElement('div');
                thinkingBubble.className = 'chat-bubble-ai p-3 rounded-lg max-w-md';
                thinkingBubble.innerHTML = '<div class="flex items-center gap-2"><div class="spinner"></div><span>AI sedang berpikir...</span></div>';
                chatWindow.appendChild(thinkingBubble);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                
                const prompt = `Anda adalah asisten AI ahli yang berperan sebagai teknisi senior dari Rentokil. Pahami istilah teknis lapangan seperti "umpan blok", "fogging manual", "spray residual". Berikan jawaban yang singkat, jelas, dan langsung bisa diterapkan, seolah-olah Anda mengacu pada basis pengetahuan Rentokil. Gunakan bullet points (*) jika perlu. Jawab pertanyaan berikut dalam Bahasa Indonesia: "${userInput}"`;
                const aiResponse = await callGeminiAPI(prompt);
                thinkingBubble.innerHTML = formatAIResponse(aiResponse);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };

            chatSendBtn.addEventListener('click', handleChatSend);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSend(); });
            clearChatBtn.addEventListener('click', initializeChat);

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = dataIdInput.value;
                const dataPayload = { tanggal: tanggalInput.value, lokasi: lokasiInput.value, jenisHama: jenisHamaInput.value, jumlah: jumlahInput.value, status: statusInput.value, keterangan: keteranganInput.value, foto: currentPhotos };
                if (id) {
                    const index = pestData.findIndex(data => data.id == id);
                    if (index > -1) pestData[index] = { ...pestData[index], ...dataPayload, id: id };
                } else {
                    pestData.push({ id: Date.now(), ...dataPayload });
                }
                saveData(); renderTable(); renderDashboard(); resetForm();
            });

            tableBody.addEventListener('click', (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;
                if (target.classList.contains('edit-btn')) startEdit(id);
                else if (target.classList.contains('delete-btn')) deleteData(id);
            });

            fotoInput.addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 3) { alert('Maksimal 3 foto.'); fotoInput.value = ''; return; }
                currentPhotos = await Promise.all(files.map(fileToBase64));
                renderImagePreview();
            });

            imagePreviewContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-img-btn')) {
                    const indexToRemove = parseInt(e.target.dataset.index, 10);
                    currentPhotos.splice(indexToRemove, 1);
                    fotoInput.value = ''; renderImagePreview();
                }
            });

            cancelEditBtn.addEventListener('click', resetForm);

            const renderAnalysisHistory = () => {
                const pestFilter = historySearchPest.value.toLowerCase();
                const locationFilter = historySearchLocation.value.toLowerCase();
                const dateFilter = historySearchDate.value;
                const filteredHistory = analysisHistory.filter(item => {
                    const itemDate = item.date.split('T')[0];
                    const pestMatch = item.result.some(r => r.namaHama.toLowerCase().includes(pestFilter));
                    const locationMatch = item.location.toLowerCase().includes(locationFilter);
                    const dateMatch = !dateFilter || itemDate === dateFilter;
                    return pestMatch && locationMatch && dateMatch;
                });
                analysisHistoryBody.innerHTML = '';
                noHistoryMessage.classList.toggle('hidden', filteredHistory.length > 0);
                filteredHistory.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-white border-b';
                    const primaryResult = item.result[0];
                    const confidenceColor = primaryResult.confidence < 70 ? 'text-red-600' : 'text-green-600';
                    const resultSummary = item.result.map(r => `${r.namaHama} (${r.jumlahHama})`).join(', ');
                    tr.innerHTML = `
                        <td class="px-4 py-2">${formatDate(item.date)}</td>
                        <td class="px-4 py-2">${item.location}</td>
                        <td class="px-4 py-2 text-xs">${resultSummary}</td>
                        <td class="px-4 py-2 font-bold ${confidenceColor}">${primaryResult.confidence}%</td>
                        <td class="px-4 py-2"><img src="${item.image}" class="w-16 h-16 object-cover rounded"></td>
                        <td class="px-4 py-2 text-xs">
                            <button class="reanalyze-btn text-blue-600 hover:underline" data-id="${item.id}">Analisis Ulang</button>
                            <button class="delete-history-btn text-red-600 hover:underline mt-1" data-id="${item.id}">Hapus</button>
                        </td>`;
                    analysisHistoryBody.appendChild(tr);
                });
            };
            
            historySearchPest.addEventListener('input', renderAnalysisHistory);
            historySearchLocation.addEventListener('input', renderAnalysisHistory);
            historySearchDate.addEventListener('change', renderAnalysisHistory);

            analysisHistoryBody.addEventListener('click', (e) => {
                const id = parseInt(e.target.dataset.id);
                if (!id) return;
                if(e.target.classList.contains('reanalyze-btn')) {
                    const item = analysisHistory.find(h => h.id === id);
                    if(item) {
                        e.target.textContent = "Menganalisis...";
                        performAnalysis(item.image, id).finally(() => { e.target.textContent = "Analisis Ulang"; });
                    }
                }
                if(e.target.classList.contains('delete-history-btn')) {
                    analysisHistory = analysisHistory.filter(h => h.id !== id);
                    saveData();
                    renderAnalysisHistory();
                }
            });

            fileInput.addEventListener('change', (event) => { /* ... (existing import logic) ... */ });
            printBtn.addEventListener('click', () => { document.getElementById('print-date').textContent = new Date().toLocaleString('id-ID'); window.print(); });
            excelBtn.addEventListener('click', () => { /* ... (existing excel logic) ... */ });
            pdfBtn.addEventListener('click', () => { /* ... (existing pdf logic) ... */ });
            deleteAllBtn.addEventListener('click', () => {
                if (confirm('APAKAH ANDA YAKIN? Semua data akan dihapus permanen.')) {
                    pestData = []; analysisHistory = [];
                    saveData(); renderTable(); renderDashboard(); renderAnalysisHistory();
                }
            });

            // Initial Render
            renderTable();
            renderDashboard();
            renderAnalysisHistory();
            switchView('data');
        });
    </script>

</body>
</html>


